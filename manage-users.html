<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Users</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .user-info {
      flex: 1;
    }
    .user-actions {
      display: flex;
      gap: 10px;
    }
    .user-actions button {
      padding: 5px 10px;
      cursor: pointer;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      width: 80%;
      max-width: 600px;
      border-radius: 5px;
    }
    .close {
      float: right;
      cursor: pointer;
      font-size: 24px;
    }
    .comments-list {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
    }
    .comment-item {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Manage Users</h1>
    <!-- Navigation for admin options -->
    <nav>
      <a href="admin-dashboard.html">Dashboard</a>
      <a href="editor.html">Create/Edit Posts</a>
    </nav>
  </header>
  <main>
    <ul id="user-list">
      <!-- User accounts will be listed here -->
    </ul>
  </main>

  <!-- Modal for user details -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle">User Details</h2>
      <div id="modalContent">
        <!-- User details and comments will be loaded here -->
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Makeup by NY</p>
  </footer>

  <!-- Firebase Firestore script to load user data -->
  <script type="module">
    // Import db from your firebase.js file, which initializes your app
    import { db } from "./firebase.js";
    // Then import Firestore functions
    import { 
      collection, 
      getDocs, 
      doc, 
      updateDoc, 
      deleteDoc, 
      query, 
      where 
    } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const userList = document.getElementById("user-list");
    const modal = document.getElementById("userModal");
    const modalContent = document.getElementById("modalContent");
    const closeBtn = document.getElementsByClassName("close")[0];
    let currentUserId = null;

    // Close modal when clicking the X
    closeBtn.onclick = function() {
      modal.style.display = "none";
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    async function loadUserComments(userId) {
      try {
        const commentsQuery = query(collection(db, "posts"), where("comments", "array-contains", userId));
        const querySnapshot = await getDocs(commentsQuery);
        let commentsHtml = '<h3>User Comments</h3>';
        
        if (querySnapshot.empty) {
          commentsHtml += '<p>No comments found for this user.</p>';
        } else {
          commentsHtml += '<div class="comments-list">';
          querySnapshot.forEach((doc) => {
            const postData = doc.data();
            if (postData.comments) {
              postData.comments.forEach(comment => {
                if (comment.userId === userId) {
                  commentsHtml += `
                    <div class="comment-item">
                      <p><strong>Post:</strong> ${postData.title}</p>
                      <p><strong>Comment:</strong> ${comment.text}</p>
                      <p><strong>Date:</strong> ${new Date(comment.createdAt.toDate()).toLocaleString()}</p>
                    </div>
                  `;
                }
              });
            }
          });
          commentsHtml += '</div>';
        }
        return commentsHtml;
      } catch (error) {
        console.error("Error loading comments:", error);
        return '<p>Error loading comments.</p>';
      }
    }

    async function showUserDetails(userId, userData) {
      currentUserId = userId;
      const commentsHtml = await loadUserComments(userId);
      
      modalContent.innerHTML = `
        <div>
          <p><strong>Email:</strong> ${userData.email}</p>
          <p><strong>Created:</strong> ${userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleString() : 'Unknown'}</p>
          <p><strong>Role:</strong> ${userData.isAdmin ? 'Admin' : 'User'}</p>
          <div class="user-actions">
            <button onclick="window.updateUserRole('${userId}', ${!userData.isAdmin})">
              ${userData.isAdmin ? 'Remove Admin' : 'Make Admin'}
            </button>
            <button onclick="window.deleteUser('${userId}')">Delete User</button>
          </div>
          ${commentsHtml}
        </div>
      `;
      modal.style.display = "block";
    }

    async function loadUsers() {
      try {
        const querySnapshot = await getDocs(collection(db, "users"));
        querySnapshot.forEach((doc) => {
          const li = document.createElement("li");
          const userData = doc.data();
          const createdAt = userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleString() : 'Unknown';
          
          li.className = "user-item";
          li.innerHTML = `
            <div class="user-info">
              <strong>Email:</strong> ${userData.email} | 
              <strong>Created:</strong> ${createdAt} |
              <strong>Role:</strong> ${userData.isAdmin ? 'Admin' : 'User'}
            </div>
            <div class="user-actions">
              <button onclick="window.showUserDetails('${doc.id}', ${JSON.stringify(userData)})">View Details</button>
            </div>
          `;
          userList.appendChild(li);
        });
      } catch (error) {
        console.error("Error loading users:", error);
        const errorMsg = document.createElement("p");
        errorMsg.textContent = "Error loading users.";
        userList.appendChild(errorMsg);
      }
    }

    // Make functions available globally for onclick handlers
    window.showUserDetails = showUserDetails;
    window.updateUserRole = async function(userId, isAdmin) {
      try {
        const userRef = doc(db, "users", userId);
        await updateDoc(userRef, { isAdmin });
        alert(`User ${isAdmin ? 'promoted to admin' : 'removed from admin role'}`);
        modal.style.display = "none";
        userList.innerHTML = ""; // Clear the list
        loadUsers(); // Reload the list
      } catch (error) {
        console.error("Error updating user role:", error);
        alert("Error updating user role");
      }
    };
    window.deleteUser = async function(userId) {
      if (confirm("Are you sure you want to delete this user? This action cannot be undone.")) {
        try {
          const userRef = doc(db, "users", userId);
          await deleteDoc(userRef);
          alert("User deleted successfully");
          modal.style.display = "none";
          userList.innerHTML = ""; // Clear the list
          loadUsers(); // Reload the list
        } catch (error) {
          console.error("Error deleting user:", error);
          alert("Error deleting user");
        }
      }
    };

    loadUsers();
  </script>
</body>
</html>
